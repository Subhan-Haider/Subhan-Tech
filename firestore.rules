rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the requester is the authorized administrator
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'setupg98@gmail.com' ||
        exists(/databases/$(database)/documents/admins/$(request.auth.token.email))
      );
    }

    // Default: Lock down everything
    match /{document=**} {
      allow read, write: if false;
    }

    // Core Content (Read: Public, Write: Admin)
    match /products/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /home_sections/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /legal_pages/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Infrastructure & Intelligence (Admin Only)
    match /audit_logs/{id} {
      allow read, write: if isAdmin();
    }
    
    match /system_config/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Interactive & Analytics (Write: Public, Read: Admin)
    match /system_events/{id} {
      allow create: if true;
      allow read: if isAdmin();
    }
    
    match /survey_responses/{id} {
      allow create: if true;
      allow read: if isAdmin();
    }
    
    match /surveys/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Redirects (Public can increment clickCount via update, Admin has full control)
    match /redirects/{id} {
      allow read: if true;
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clickCount', 'lastClicked']);
      allow write: if isAdmin();
    }

    // Admin List (System Protection)
    match /admins/{email} {
      allow read: if request.auth != null;
      allow write: if false; // Manual overhead required for new admins
    }
  }
}